name: Check dependencies health

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on: 
  #schedule:
    #- cron: '*/15 * * * *'
  pull_request:
  workflow_dispatch:
  
jobs:
  Health_check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
    - name: Checkout
      uses: actions/checkout@v3.1.0
    
    - name: Check health
      id: check_health
      run: |
        ./gradlew buildHealth
        report_file=build/reports/dependency-analysis/build-health-report.txt
        if [[ -f $report_file && -s $report_file ]]; then
          echo "Report is successfully generated"
          echo report_file=$report_file >> $GITHUB_OUTPUT;
        else 
          echo "Report is missing"
          echo report_file= >> $GITHUB_OUTPUT;
        fi
        
    - name: Report
      id: report
      if: ${{ steps.check_health.outputs.report_file != '' }}
      continue-on-error: true
      run: |
        report="$(cat ${{ steps.check_health.outputs.report_file }})"
        echo "$report"
        delimiter="$(openssl rand -hex 8)"
        echo "report<<${delimiter}" >> "${GITHUB_OUTPUT}"
        echo "$report" >> "${GITHUB_OUTPUT}"
        echo "${delimiter}" >> "${GITHUB_OUTPUT}"
        exit 1
        
    - name: Comment on PR
      if: ${{ steps.report.outputs.report != '' }}
      uses: mshick/add-pr-comment@v2
      with:
        message-id: health_check
        message: |
          ## ⚠ Dependencies Health Check ⚠
          
          <details>
          <summary>
          Full Report
          </summary>
          <p>
          
          ### Advices for ${{ github.event.repository.name }}:
          
          ${{ steps.report.outputs.report }}
          
          </p>
          </details>
          
